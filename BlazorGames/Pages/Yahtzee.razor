@page "/yahtzee"

@using BlazorGames.Models.Yahtzee;
@using BlazorGames.Models.Yahtzee.Enums;
@using BlazorGames.Models.Common;
@using BlazorGames.Pages.Partials; 

<PageTitle Title="Yahtzee" />

@code {
    public DieCollection Dice { get; set; } = new DieCollection();

    public PlayCollection PlaysMade { get; set; } = new PlayCollection();

    public int TurnsRemaining { get; set; } = 13;

    public int RollsRemaining { get; set; } = 3;

    public bool IsStartOfTurn { get { return RollsRemaining >= 3; } }

    public bool IsGameOver { get { return TurnsRemaining <= 0; } }

    public bool ShowRules { get; set; }

    public int TotalScore
    {
        get
        {
            if (PlaysMade.HasBonus())
            {
                return PlaysMade.GetTotal() + 35;
            }
            return PlaysMade.GetTotal();
        }
    }

    public Yahtzee()
    {
        Initialize();
    }

    public void Initialize()
    {
        Dice.Reset();

        PlaysMade.Reset();
        TurnsRemaining = 13;
        RollsRemaining = 3;
    }

    public async Task RollDice()
    {
        Random rand = new Random();

        var unheldDice = Dice.Dice.Where(x => x.IsHeld == false);

        foreach (var die in unheldDice)
        {
            die.State = DieState.Rolling;
        }

        foreach (var die in unheldDice)
        {
            await Task.Delay(200);
            die.State = DieState.Stopped;
            die.Value = rand.Next(1, 7);
            StateHasChanged();
        }
        RollsRemaining--;
    }

    public void NextTurn()
    {
        RollsRemaining = 3;
        TurnsRemaining--;
        Dice.ReleaseHold();
    }

    public bool CanMakePlay(PlayType type) =>
        type switch
        {
            PlayType.Ones => Dice.HasThreeOnes(),
            PlayType.Twos => Dice.HasThreeTwos(),
            PlayType.Threes => Dice.HasThreeThrees(),
            PlayType.Fours => Dice.HasThreeFours(),
            PlayType.Fives => Dice.HasThreeFives(),
            PlayType.Sixes => Dice.HasThreeSixes(),
            PlayType.Yahtzee |
            PlayType.BonusYahtzee => Dice.HasYahtzee(),
            PlayType.ThreeOfAKind => Dice.HasThreeOfAKind(),
            PlayType.FourOfAKind => Dice.HasFourOfAKind(),
            PlayType.FullHouse => Dice.HasFullHouse(),
            PlayType.SmallStraight => Dice.HasSmallStraight(),
            PlayType.LargeStraight => Dice.HasLargeStraight(),
            PlayType.Chance => true,
            _ => false
        };

    public void ClaimPlay(PlayType type)
    {
        var value = type switch
        {
            PlayType.Ones => Dice.GetSumOf(1),
            PlayType.Twos => Dice.GetSumOf(2),
            PlayType.Threes => Dice.GetSumOf(3),
            PlayType.Fours => Dice.GetSumOf(4),
            PlayType.Fives => Dice.GetSumOf(5),
            PlayType.Sixes => Dice.GetSumOf(6),
            PlayType.Yahtzee => 50,
            PlayType.BonusYahtzee => 100,
            PlayType.ThreeOfAKind => Dice.GetOfAKindTotal(3),
            PlayType.FourOfAKind => Dice.GetOfAKindTotal(4),
            PlayType.FullHouse => 25,
            PlayType.SmallStraight => 30,
            PlayType.LargeStraight => 40,
            PlayType.Chance => Dice.Dice.Sum(x => x.Value),
            _ => throw new ArgumentException("Invalid value", nameof(type))
        };

        PlaysMade.Add(type, value);

        NextTurn();
    }

    public void ScratchPlay(PlayType type)
    {
        PlaysMade.Add(type, 0);
        NextTurn();
    }

    public string GetRank() =>
        TotalScore switch
        {
            _ when !IsGameOver => "Finish the game first!",
            <= 112 => "D",
            > 112 and <= 168 => "C",
            > 168 and <= 224 => "B",
            > 224 and <= 280 => "A",
            > 280 and <= 364 => "S",
            > 364 => "S+",
        };
}

<div class="container">
    <div class="row">
        <div class="col-2">
            @for (int i = 0; i < Dice.Dice.Count; i++)
            {
                var x = i;
                var die = Dice.Dice[x];
                <YahtzeeDie Die="die" IsStartOfTurn="IsStartOfTurn"/>
            }
            <div class="row">
                <div class="col">
                    @if (RollsRemaining > 0 && !IsGameOver)
                    {
                        <button class="btn btn-primary" @onclick:preventDefault @onclick="@(() => RollDice())">Roll</button>
                    }
                    else if (IsGameOver)
                    {
                        <button class="btn btn-success" @onclick="@(() => Initialize())">Reset</button>
                        <text>Thanks for playing!<br />Final score: @TotalScore <br />Rank: @GetRank()</text>
                    }
                    else
                    {
                        <button class="btn btn-primary disabled" @onclick:preventDefault @onclick="@(() => RollDice())">Roll</button><text>Please mark a score.</text>
                    }
                </div>
            </div>
        </div>
        <div class="col-8">
            <div class="row">
                <div class="col">
                    <h4>Scorecard</h4>
                </div>
            </div>
            <div class="row">
                <div class="col-4">
                    Rolls Remaining This Turn: @RollsRemaining
                </div>
                <div class="col-4">
                    Turns Remaining: @TurnsRemaining
                </div>
            </div>
            <!-- Scorecard rows -->
            @foreach (PlayType type in (PlayType[])Enum.GetValues(typeof(PlayType)))
            {
                @if (type != PlayType.BonusYahtzee || (type == PlayType.BonusYahtzee && PlaysMade.HasYahtzee()))
                {
                    <div class="row @(type == PlayType.BonusYahtzee ? "bg-warning" : "")">
                        <div class="col-6 border border-dark font-weight-bold">
                            @type.GetDisplayName()
                            <i class="fa fa-question-circle" title="@type.GetDisplayDescription()"></i>
                        </div>
                        <div class="col-6 border border-dark p-1 min">
                            @if (PlaysMade.HasPlay(type))
                            {
                                @PlaysMade.GetScore(type)
                            }
                            else if (CanMakePlay(type) && !IsStartOfTurn)
                            {
                                <a class="btn btn-primary btn-sm" @onclick="@(() => ClaimPlay(type))">Claim</a>
                            }
                            else if (RollsRemaining == 0)
                            {
                                <a class="btn btn-outline-secondary btn-sm" @onclick="@(() => ScratchPlay(type))">Scratch</a>
                            }
                        </div>
                    </div>
                }
            }
            <div class="row">
                <div class="col-6 border border-dark font-weight-bold">TOP SECTION BONUS <i class="fa fa-question-circle" title="If your scores for ones, twos, threes, fours, fives, and sixes total 63 or more, you get a 35 point bonus!"></i></div>
                <div class="col-6 border border-dark p-1">
                    @if (PlaysMade.HasBonus())
                    {
                        <text>35</text>
                    }
                    else
                    {
                        <text>0</text>
                    }
                </div>
            </div>
            <div class="row">
                <div class="col-6 border border-dark font-weight-bold">GRAND TOTAL</div>
                <div class="col-6 border border-dark p-1">
                    @TotalScore
                </div>
            </div>
        </div>
    </div>
</div>

<YahtzeeRules/>

<hr />

<h2>How To Make Yahtzee in Blazor WebAssembly</h2>

<p>
    Check out the blog posts below!
</p>

<ul>
    <li><a href="https://exceptionnotfound.net/yahtzee-in-blazor-webassembly-part-1-the-csharp-model/" target="_blank">Part 1: The C# Model</a></li>
    <li><a href="https://exceptionnotfound.net/yahtzee-in-blazor-webassembly-part-2-the-blazor-component/" target="_blank">Part 2: The Blazor Component</a></li>
</ul>